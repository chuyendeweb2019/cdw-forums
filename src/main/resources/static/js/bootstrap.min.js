$(document).ready(function(){
  $(".btn1").click(function(){
    $("#chat-container").hide();
  });
  $(".btn-outline-info").click(function(){
    $("#chat-container").show();
  });
});


// A $( document ).ready() block.
$( document ).ready(function() {
	 $("#chat-container").hide();
//	var list = ['/','yyyyyyyyyyyyy'].filter(function (x)  { return window.location.href.indexOf(x) != -1 })
//	if(list.length == 0) {
//		 $("#chat-container").hide();
//	}
	var messageForm = document.querySelector('#messageForm');
	var messageInput = document.querySelector('#message');
	var messageArea = document.querySelector('#messageArea');
	var connectingElement = document.querySelector('#connecting');
	 
	var stompClient = null;
	var username = null;
    console.log( "ready!" );
    var username = $('body > header > span > b').html();
  
    function connect() {
    
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
     
        stompClient.connect({}, onConnected, onError);
    }
    
    function onError(error) {
       console.log(error);
    }
     
    function onMessageReceived(payload) {
        var message = JSON.parse(payload.body);
        console.log(message);
        var messageElement = document.createElement('li');
        
        if(message.type === 'JOIN') {
            messageElement.classList.add('event-message');
            message.content = message.sender + ' đã tham gia!';
      } 
       else if (message.type === 'LEAVE') {
//            messageElement.classList.add('event-message');
//            message.content = message.sender + ' left!';
        }
        else {
            messageElement.classList.add('chat-message');   
            var usernameElement = document.createElement('strong');
            usernameElement.classList.add('nickname');
            var usernameText = document.createTextNode(message.sender);
            var usernameText = document.createTextNode(message.sender);
            usernameElement.appendChild(usernameText);
            messageElement.appendChild(usernameElement);
        }
     
        var textElement = document.createElement('span');
        var messageText = document.createTextNode(message.content);
        if(message.type !== 'LEAVE') {
        	   textElement.appendChild(messageText);
        	   messageElement.appendChild(textElement);
        	    messageArea.appendChild(messageElement);
        	     messageArea.scrollTop = messageArea.scrollHeight;
        }
     
     
      
     
    
   
    }
    function onConnected() {
        // Subscribe to the Public Topic
        stompClient.subscribe('/topic/publicChatRoom', onMessageReceived);
     
        // Tell your username to the server
        stompClient.send("/app/chat.addUser",
            {},
            JSON.stringify({sender: username, type: 'JOIN'})
        )
     
    }
    function sendMessage(event) {
        var messageContent = messageInput.value.trim();
        if(messageContent && stompClient) {
            var chatMessage = {
                sender: username,
                content: messageInput.value,
                type: 'CHAT'
            };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
        event.preventDefault();
    }
  if(username){
	  connect() ;
	  messageForm.addEventListener('submit', sendMessage, true);
	  
    } 
  else {
	  $("#chat-container").hide();
  }
    
    
});
